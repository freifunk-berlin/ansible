---
# dependency: role webserver before
# modify webserver to buildbot-environment

- name: install python virtual-env
  apt:
    name: virtualenv
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: buildbot initialised already?
  stat:
    path: /usr/local/src/buildbot/
  register: buildbot

- name: checkout buildbot-config
  git:
    repo: 'https://github.com/freifunk-berlin/buildbot.git'
    dest: /usr/local/src/buildbot/
    version: master
  when: not buildbot.stat.exists

- name: install buildbot in venv
  pip:
    name: buildbot
    virtualenv: /usr/local/src/buildbot/env
  register: buildbot_install
  
- name: initialise buildbot-master
  command: /usr/local/src/buildbot/env/bin/buildbot create-master /usr/local/src/buildbot/masters/master
  when: buildbot_install.changed

- name: create images-dir
  file:
    state: directory
    path: /usr/local/src/www/htdocs/buildbot/

- name: add buildbot systemd-service-module
  copy:
    dest: /etc/systemd/system/buildbot.service
    mode: 0644
    content: |
      [Unit]
      Description=Buildbot-master for Freifunk-Berlin

      [Service]
      WorkingDirectory=/usr/local/src/buildbot/masters/master
      Environment=PATH=/usr/local/src/buildbot/env/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin
      ExecStart=/usr/local/src/buildbot/env/bin/buildbot start --nodaemon
      ExecReload=/bin/kill -HUP $MAINPID

      [Install]
      WantedBy=multi-user.target

- name: enable and start buildbot systemd service
  systemd:
    daemon_reload: yes
    name: buildbot
    enabled: true
    state: started

- name: firmware-selector initialised already?
  stat:
    path: /usr/local/src/www/htdocs/firmware-selector
  register: fw_selector

- name: checkout firmware-selector
  git:
    repo: 'https://github.com/freifunk-berlin/falter-firmware-selector.git'
    version: falter_stable
    dest: /usr/local/src/www/htdocs/firmware-selector
  when: not fw_selector.stat.exists

- name: run link_www to link files into website-root
  command: /usr/local/src/www/htdocs/firmware-selector/link_www.sh
  when: not fw_selector.stat.exists

- name: insert cronjob for firmware-selector
  cron:
    name: update snapshots in firmware-selector regularily.
    minute: "*/10"
    job: /usr/local/src/www/htdocs/firmware-selector/get_profiles_local.sh
    user: root
    cron_file: ansible_fwselector_update

- name: adjust directory-permissions for buildbot
  file:
    path: /usr/local/src/buildbot
    owner: buildbot
    group: root
    mode: 0755
    recurse: yes

- name: adjust directory-permissions for web-stuff
  file:
    path: /usr/local/src/www/
    owner: www-data
    group: buildbot
    mode: 0755
    recurse: yes

...
