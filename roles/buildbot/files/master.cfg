# -*- python -*-
# ex: set filetype=python:

#
# Notes:
# * signify key is expected at <masterdir>/packagefeed_master.sec
# * build artifacts are copied to <masterdir>/public_html
# * additional source files are required: {secs,packages,targets,asyncbuild,notify}.py
#

#
# Noteworthy Buildbot features used here:
#
# Dynamic build factories a.k.a. addStepsAfterCurrentStep
# https://docs.buildbot.net/3.6.0/manual/configuration/buildfactories.html
#
# Trigger steps and Triggerable schedulers
# https://docs.buildbot.net/3.6.0/manual/configuration/steps/trigger.html
#
# Parallelized Trigger steps, adapter from @vit9696's code
# https://github.com/buildbot/buildbot/issues/3088
#
# Virtual builders
# https://docs.buildbot.net/3.6.0/manual/configuration/builders.html
#

from datetime import timedelta
from config import config

from buildbot.plugins import *

bmc = BuildmasterConfig = {}

bmc['title'] = config['title']
bmc['titleURL'] = config['titleURL']
bmc['buildbotURL'] = config['buildbotURL']
bmc['buildbotNetUsageData'] = None

bmc['db'] = {'db_url': config['dbURL']}
bmc['protocols'] = {'pb': {'port': config['pbPort']}}
bmc['workers'] = [worker.Worker(w[0], w[1]) for w in config['workers']]

bmc['configurators'] = [util.JanitorConfigurator(
    logHorizon=timedelta(weeks=4),
    hour=6,
    minute=0,
)]

bmc['www'] = dict(port=config['wwwPort'],
                plugins=dict(),
                change_hook_dialects={
                    'github': {
                        'secret': config['webhookSecret'],
                        'strict': True}
                    }
                )

bmc['www']['auth'] = util.GitHubAuth(config['githubClientID'], config['githubClientSecret'])
bmc['www']['authz'] = util.Authz(
    roleMatchers=[util.RolesFromGroups()],
    allowRules=[util.AnyControlEndpointMatcher(role=config['githubOrg'])])
bmc['www']['avatar_methods'] = [util.AvatarGitHub()]
bmc['www']['ui_default_config'] = {
    'Links.build_link_template': "#%(build_number)",
    'Home.sidebar_menu_groups_expand_behavior': "Always expand",
    'Builders.buildFetchLimit': 100,
    'Builders.page_size': 10,
    'Build.trigger_step_page_size': 200,
    'BuildRequests.buildrequestFetchLimit': 100,
}

bmc['change_source'] = []
bmc['services'] = []
bmc['schedulers'] = []
bmc['builders'] = []

# see ./packages.py
from packages import packagesConfig
bmc = packagesConfig(bmc, config)

# see ./targets.py
from targets import targetsConfig
bmc = targetsConfig(bmc, config)

# see ./notify.py
from notify import MatrixNotifier
bmc['services'].append(
    MatrixNotifier(
        homeserver=config['matrixHomeserver'],
        accessToken=config['matrixAccessToken'],
        room=config['matrixRoom']))


#########################
#   Define Schedulers   #
#########################
from buildbot.schedulers.basic import SingleBranchScheduler, AnyBranchScheduler
from buildbot.schedulers.timed import Periodic, Nightly
from buildbot.changes import filter


bmc['change_source'].append(changes.GitPoller(
    workdir='gitpoller-packages',
    pollAtLaunch=True,
    pollInterval=3600*24,
    repourl=config['packages_repo'],
    branches=config['packages_branches'],
))
bmc['change_source'].append(changes.GitPoller(
    workdir='gitpoller-builter',
    pollAtLaunch=True,
    pollInterval=3600*24,
    repourl=config['builter_repo'],
    branches=config['builter_branches'],
))


bmc['schedulers'].append(AnyBranchScheduler(
    name="webhook-packages",
    change_filter=filter.ChangeFilter(
        repository=config['packages_repo'].removesuffix('.git'),
        branch=config['packages_branches']),
    treeStableTimer=60,
    builderNames=["builds/packages"]))


# bmc['schedulers'].append(Nightly(
#     name="nightly-snapshot",
#     dayOfWeek=[0,3],
#     hour=0, # in local timezone of the host running buildbot
#     createAbsoluteSourceStamps=True,
#     onlyIfChanged=False,
#     builderNames=["builds/targets"],
#     codebases={"": {
#         "repository": config['builter_repo'],
#         "branch": config['builter_branches'][0],
#     }},
#     properties={
#         "falterBranch":"snapshot",
#         "falterVersion":"snapshot",
#     }))


# bmc['schedulers'].append(Nightly(
#     name="nightly-1.4.0-snapshot",
#     dayOfWeek=[2,5],
#     hour=0, # in local timezone of the host running buildbot
#     createAbsoluteSourceStamps=True,
#     onlyIfChanged=False,
#     builderNames=["builds/targets"],
#     codebases={"": {
#         "repository": config['builter_repo'],
#         "branch": config['builter_branches'][0],
#     }},
#     properties={
#         "falterBranch":"1.4.0-snapshot",
#         "falterVersion":"1.4.0-snapshot",
#     }))


# bmc['schedulers'].append(Nightly(
#     name="nightly-1.3.0-snapshot",
#     dayOfWeek=[1,4],
#     hour=0, # in local timezone of the host running buildbot
#     createAbsoluteSourceStamps=True,
#     onlyIfChanged=False,
#     builderNames=["builds/targets"],
#     codebases={"": {
#         "repository": config['builter_repo'],
#         "branch": config['builter_branches'][0],
#     }},
#     properties={
#         "falterBranch":"1.3.0-snapshot",
#         "falterVersion":"1.3.0-snapshot",
#     }))
