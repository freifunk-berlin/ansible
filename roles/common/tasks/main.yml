---
# tasks to be run on all machines
- name: Install basic tools
  apt:
    name:
      - atop
      - collectd
      - curl
      - fail2ban
      - git
      - gpg
      - gpg-agent
      - htop
      - mc
      - mosh
      - nano
      - prometheus-node-exporter
      - tcpdump
      - tmux
      - vnstat
      - zsh
    state: present
    update_cache: true

# Collectd config
- name: Copy collectd config
  template:
    src: collectd-ffberlin.conf.j2
    dest: /etc/collectd/collectd.conf.d/ffberlin.conf
    mode: 0640
    owner: root
    group: root
  notify: Restart collectd

- name: Configure fail2ban-jails
  template:
    src: fail2ban-ffberlin.local.j2
    dest: /etc/fail2ban/jail.local
    mode: 0640
    owner: root
    group: root
  notify: Restart fail2ban

- name: Copy custom motd
  template:
    src: motd.j2
    dest: /etc/motd
    mode: 0640
    owner: root
    group: root

- name: Configure prometheus-node-exporter
  template:
    src: prometheus-node-exporter.j2
    dest: /etc/default/prometheus-node-exporter
    mode: 0640
    owner: root
    group: root
  notify: Restart prometheus-node-exporter

- name: Disallow password-based login for all users
  lineinfile:
    path: /etc/ssh/sshd_config
    line: 'PasswordAuthentication no'
    insertafter: EOF
  notify: Restart sshd

- name: Disallow login for root user
  lineinfile:
    path: /etc/ssh/sshd_config
    line: 'PermitRootLogin no'
    insertafter: EOF
  notify: Restart sshd

- name: Set Journald Max Size to 1G
  ansible.builtin.lineinfile:
    path: /etc/systemd/journald.conf
    insertafter: '^#SystemMaxUse'
    regexp: '^SystemMaxUse'
    line: SystemMaxUse=1G
  notify: Restart journald
