---
services:
  caddy:
    image: caddy:latest
    container_name: caddy
    restart: unless-stopped
    volumes:
      - ${VOLUME_DIR:-./.volumes}/caddy/data:/data
      - ${VOLUME_DIR:-./.volumes}/caddy/config:/config
      - ${VOLUME_DIR:-./.volumes}/caddy/Caddyfile:/etc/caddy/Caddyfile
    ports:
      # http
      - "80:80"
      # https
      - "443:443"
    networks:
      - "proxy"
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.13.0
    container_name: oauth2-proxy
    restart: unless-stopped
    environment:
      OAUTH2_PROXY_HTTP_ADDRESS: "0.0.0.0:4180"
      OAUTH2_PROXY_REVERSE_PROXY: true
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_COOKIE_NAME: "_oauth2_proxy"
      OAUTH2_PROXY_COOKIE_SECRET: "secret"
      OAUTH2_PROXY_COOKIE_DOMAIN: ".proxy.domain.dev"
      OAUTH2_PROXY_COOKIE_SECURE: "true"
      OAUTH2_PROXY_COOKIE_SAMESITE: lax
      OAUTH2_PROXY_WHITELIST_DOMAINS: ".proxy.domain.dev"
      OAUTH2_PROXY_SET_XAUTHREQUEST: "true"
      OAUTH2_PROXY_PROVIDER: oidc
      OAUTH2_PROXY_CLIENT_ID: "client-id"
      OAUTH2_PROXY_CLIENT_SECRET: "client-secret"
      OAUTH2_PROXY_OIDC_ISSUER_URL: "https://login.microsoftonline.com/<tenant-id>/v2.0"
      OAUTH2_PROXY_REDIRECT_URL: "https://auth.proxy.domain.dev/oauth2/callback"
      OAUTH2_PROXY_SCOPE: "openid email profile offline_access"
      OAUTH2_PROXY_UPSTREAMS: "file:///dev/null"
    ports:
      - "4180:4180"
    networks:
      - "proxy"
networks:
  proxy:
