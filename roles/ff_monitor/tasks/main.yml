---
- name: Add grafana signing key
  ansible.builtin.apt_key:
    url: https://apt.grafana.com/gpg.key
    state: present

- name: Add grafana APT Repo
  ansible.builtin.apt_repository:
    repo: "deb https://apt.grafana.com stable main"
    state: present
    update_cache: false

- name: Install dependencies
  apt:
    name:
      - grafana
      - prometheus
      - collectd
      - docker.io
    state: present
    update_cache: true
    cache_valid_time: 3600

- name: Copy prometheus config
  template:
    dest: /etc/prometheus/prometheus.yml
    src: prometheus.yml.j2
    mode: 0640
    owner: prometheus
    group: prometheus
  notify: Restart prometheus

- name: Copy prometheus defaults
  template:
    dest: /etc/default/prometheus
    src: prometheus.j2
    mode: 0640
    owner: root
    group: root
  notify: Restart prometheus

- name: Start prometheus collectd-exporter
  community.general.docker_container:
    name: collectd-exporter
    state: started
    image: prom/collectd-exporter
    command: --collectd.listen-address=":25826"
    ports:
      - 9104:9103
      - 127.0.0.1:25827:25826/udp

- name: Copy grafana config
  template:
    dest: /etc/grafana/grafana.ini
    src: grafana.ini.j2
    mode: 0640
    owner: grafana
    group: grafana
  notify: Restart grafana

- name: Copy collectd config
  template:
    dest: /etc/collectd/collectd.conf
    src: collectd.conf.j2
    mode: 0644
    owner: root
    group: root
  notify: Restart collectd

- name: Add cleanup task
  ansible.builtin.cron:
    name: remove old rrd files
    special_time: daily
    user: root
    job: "find /mnt/collectd/rrd/ -type f -mtime +90 -delete; find /mnt/collectd/rrd/ -type d -empty -delete"
